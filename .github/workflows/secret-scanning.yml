name: Secret Scanning

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  scan-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for Firebase API keys
        run: |
          echo "üîç Scanning for exposed API keys..."
          
          # Pattern to match Firebase API keys
          API_KEY_PATTERN="AIzaSy[a-zA-Z0-9_-]{35}"
          
          # Files to exclude from scanning
          EXCLUDE_PATTERNS="node_modules|\.git|\.github|build|dist|\.env"
          
          # Search for API keys (excluding certain directories)
          if grep -r -E "$API_KEY_PATTERN" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=build --exclude-dir=dist . | grep -v ".env" | grep -v "config.ts"; then
            echo "‚ùå ERROR: Found exposed API keys in repository!"
            echo "‚ö†Ô∏è  API keys should NEVER be committed to Git!"
            echo "Please remove API keys from the files and use environment variables instead."
            exit 1
          fi
          
          echo "‚úÖ No API keys found in repository"

      - name: Check for other secrets
        run: |
          echo "üîç Scanning for other common secrets..."
          
          # Check for common secret patterns
          SECRET_PATTERNS=(
            "AKIA[0-9A-Z]{16}"  # AWS Access Key
            "sk_live_[0-9a-zA-Z]{24,}"  # Stripe Live Key
            "xoxb-[0-9]{11}-[0-9]{11}-[0-9a-zA-Z]{24}"  # Slack Bot Token
          )
          
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -E "$pattern" --exclude-dir=node_modules --exclude-dir=.git .; then
              echo "‚ö†Ô∏è  WARNING: Found potential secret matching pattern: $pattern"
            fi
          done
          
          echo "‚úÖ Secret scanning complete"

